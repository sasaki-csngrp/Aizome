# AWS S3 プロキシ設定ガイド

## 概要

本アプリでは、S3バケットのパブリックアクセスをブロックし、サーバーレス関数（APIルート）をプロキシとして利用して、動画や音声コンテンツにアクセスします。

## 前提条件

- AWSアカウントへのアクセス権限
- IAMユーザー作成権限
- S3バケットへのアクセス権限

## 1. IAMユーザーの作成

### 1.1 ユーザー作成

1. AWSコンソールにログイン
2. **IAM** → **ユーザー** → **ユーザーを作成**
3. ユーザー名を設定（例: `aizome-s3-proxy`）
4. **アクセスの種類を選択**:
   - ✅ **プログラムによるアクセスを提供** にチェック
5. **次へ** をクリック

### 1.2 権限の付与

#### オプションA: 既存ポリシーを使用（簡単）

**読み取り専用の場合:**
- `AmazonS3ReadOnlyAccess` を選択

**読み書き両方必要な場合:**
- `AmazonS3FullAccess` を選択（推奨されません）

#### オプションB: カスタムポリシーを作成（推奨）

特定のバケットのみにアクセスを制限するカスタムポリシーを作成します。

1. **IAM** → **ポリシー** → **ポリシーを作成**
2. JSONタブで以下のポリシーを貼り付け（`aizome-◎◎-1` を実際のバケット名に置き換え）:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion"
      ],
      "Resource": "arn:aws:s3:::aizome-◎◎-1/*"
    },
    {
      "Effect": "Allow",
      "Action": "s3:ListBucket",
      "Resource": "arn:aws:s3:::aizome-◎◎-1",
      "Condition": {
        "StringLike": {
          "s3:prefix": ["contents/*"]
        }
      }
    }
  ]
}
```

3. ポリシー名を設定（例: `AizomeS3ReadOnly`）
4. **ポリシーを作成**
5. ユーザー作成画面に戻り、作成したカスタムポリシーを選択

### 1.3 ユーザー作成の完了

1. タグは必要に応じて追加（省略可）
2. **ユーザーを作成** をクリック

## 2. アクセスキーの作成

1. 作成したユーザーを選択
2. **セキュリティ認証情報** タブを開く
3. **アクセスキーを作成** をクリック
4. **ユースケースの選択**:
   - **他のAWSサービス、アプリケーション、またはオンプレミスプログラムで実行するコード** を選択
5. **次へ** → **アクセスキーを作成**
6. **重要**: 以下の情報をコピーして安全な場所に保存
   - **アクセスキーID**
   - **シークレットアクセスキー**（この画面でしか表示されません）

## 3. S3バケットの設定

### 3.1 パブリックアクセスのブロック

1. **S3** → 対象のバケット（`aizome-◎◎-1`）を選択
2. **アクセス許可** タブ → **パブリックアクセス設定を編集**
3. **パブリックアクセスをすべてブロック** に変更:
   - ✅ 新しいパブリック ACL とパブリックオブジェクトの通過をブロック
   - ✅ パブリック ACL を通じたパブリックオブジェクトへのアクセスをブロック
4. **変更を保存**

### 3.2 バケットポリシー（オプション）

バケットポリシーで、作成したIAMユーザーからのアクセスのみを許可することも可能です。

## 4. 環境変数の設定

### 4.1 ローカル開発環境（`.env.local`）

プロジェクトルートに `.env.local` ファイルを作成（既に存在する場合は追加）:

```env
AWS_ACCESS_KEY_ID=AKIAXXXXXXXXXXXXXXXX
AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
AWS_REGION=ap-northeast-1
AWS_S3_BUCKET_NAME=aizome-◎◎-1
```

**注意**: `.env.local` は `.gitignore` に含まれているため、Gitにコミットされません。

### 4.2 Vercel本番環境

1. Vercelダッシュボードにログイン
2. プロジェクトを選択
3. **Settings** → **Environment Variables**
4. 以下の環境変数を追加:

| 変数名 | 値 |
|--------|-----|
| `AWS_ACCESS_KEY_ID` | 作成したアクセスキーID |
| `AWS_SECRET_ACCESS_KEY` | 作成したシークレットアクセスキー |
| `AWS_REGION` | リージョン（例: `ap-northeast-1`） |
| `AWS_S3_BUCKET_NAME` | バケット名（例: `aizome-◎◎-1`） |

5. 各環境（Production, Preview, Development）に適用するか選択
6. **Save** をクリック

## 5. セキュリティベストプラクティス

### 5.1 最小権限の原則

- 必要な権限のみを付与する
- カスタムポリシーを使用して特定のバケットのみにアクセスを制限

### 5.2 アクセスキーの管理

- ✅ Gitリポジトリにコミットしない（`.env.local` は既に `.gitignore` に含まれています）
- ✅ 定期的にローテーション（3-6ヶ月ごと）
- ✅ 不要になったアクセスキーは削除
- ✅ アクセスキーは安全な場所（パスワードマネージャーなど）に保存

### 5.3 監査とモニタリング

- CloudTrailでアクセスログを確認
- 異常なアクセスパターンを検出
- 定期的にアクセスログをレビュー

### 5.4 IAMロールの使用（将来的な改善）

将来的には、Vercelが対応している場合、IAMロールを使用することでアクセスキーを完全に排除できます。

## 6. トラブルシューティング

### 6.1 アクセス拒否エラー

- IAMユーザーに適切な権限が付与されているか確認
- バケット名が環境変数と一致しているか確認
- リージョンが正しいか確認

### 6.2 環境変数が読み込まれない

- 環境変数名のタイポを確認
- Vercelの場合は、デプロイ後に再デプロイが必要な場合があります
- ローカル環境の場合は、`.env.local` ファイルが正しい場所にあるか確認

### 6.3 S3オブジェクトが見つからない

- オブジェクトキー（パス）が正しいか確認
- バケット名が正しいか確認
- オブジェクトが実際に存在するか、AWSコンソールで確認

## 7. 実装の詳細

詳細な実装については、以下のファイルを参照してください:

- `/app/api/media/[...path]/route.ts` - S3プロキシAPIルート
- `/app/components/Media.tsx` - Video/Audioコンポーネント

## 8. 参考リンク

- [AWS IAM ユーザーガイド](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_users.html)
- [AWS S3 バケットポリシー](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/bucket-policies.html)
- [Vercel 環境変数](https://vercel.com/docs/concepts/projects/environment-variables)

